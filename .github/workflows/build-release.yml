name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      plugin_name:
        description: 'Plugin name to build'
        required: true
        default: specraum
        type: choice
        options:
          - specraum
          - bassic
      platforms:
        description: 'Platforms to build (windows,macos,linux,all)'
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
          - windows,macos
          - windows,linux
          - macos,linux

env:
  BUILD_TYPE: Release
  PLUGIN_NAME: ${{ github.event.inputs.plugin_name || 'specraum' }}

jobs:
  # ============================================
  # WINDOWS BUILD
  # ============================================
  build-windows:
    if: github.event.inputs.platforms == 'all' || contains(github.event.inputs.platforms, 'windows') || github.event_name == 'push'
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install WebView2 SDK
        shell: pwsh
        run: |
          $pkgRoot = Join-Path $env:RUNNER_TEMP "nuget-packages"
          nuget install Microsoft.Web.WebView2 -Version 1.0.3485.44 -OutputDirectory $pkgRoot
          if (!(Test-Path $pkgRoot)) {
            throw "WebView2 package root not found at $pkgRoot"
          }
          "JUCE_WEBVIEW2_PACKAGE_LOCATION=$pkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DAPC_ENABLE_VISAGE=ON `
            -DAPC_AUTO_COPY_VST3_TO_SYSTEM_DIR=OFF `
            -DAPC_OPEN_BUILD_FOLDER_AFTER_BUILD=OFF `
            -DJUCE_WEBVIEW2_PACKAGE_LOCATION="$env:JUCE_WEBVIEW2_PACKAGE_LOCATION"

      - name: Build VST3
        run: |
          cmake --build build --config Release --target "${{ env.PLUGIN_NAME }}_VST3"

      - name: Build CLAP
        shell: pwsh
        run: |
          $targetsFile = Get-ChildItem -Path build -Recurse -Filter TargetDirectories.txt | Select-Object -First 1
          if ($null -eq $targetsFile) {
            throw "TargetDirectories.txt not found under build/"
          }
          if (Select-String -Path $targetsFile.FullName -SimpleMatch -Pattern "${{ env.PLUGIN_NAME }}_CLAP.dir" -Quiet) {
            cmake --build build --config Release --target "${{ env.PLUGIN_NAME }}_CLAP"
          } else {
            Write-Host "CLAP target ${{ env.PLUGIN_NAME }}_CLAP is not available; skipping."
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.PLUGIN_NAME }}
          path: |
            build/**/*.vst3
            build/**/*.clap
          retention-days: 30

  # ============================================
  # MACOS BUILD
  # ============================================
  build-macos:
    if: github.event.inputs.platforms == 'all' || contains(github.event.inputs.platforms, 'macos') || github.event_name == 'push'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          brew install cmake || true

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Xcode \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_OBJCXX_STANDARD=20 \
            -DAPC_AUTO_COPY_VST3_TO_SYSTEM_DIR=OFF \
            -DAPC_OPEN_BUILD_FOLDER_AFTER_BUILD=OFF \
            -DAPC_ENABLE_VISAGE=ON

      - name: Build VST3
        run: |
          cmake --build build --config Release --target "${{ env.PLUGIN_NAME }}_VST3"

      - name: Build CLAP
        run: |
          targets_file="$(find build -name TargetDirectories.txt | head -n 1)"
          if [ -z "$targets_file" ]; then
            echo "TargetDirectories.txt not found under build/; skipping CLAP."
          elif grep -q "${{ env.PLUGIN_NAME }}_CLAP.dir" "$targets_file"; then
            cmake --build build --config Release --target "${{ env.PLUGIN_NAME }}_CLAP"
          else
            echo "CLAP target ${{ env.PLUGIN_NAME }}_CLAP is not available; skipping."
          fi

      - name: Build AU (BASSic only)
        if: env.PLUGIN_NAME == 'bassic'
        run: |
          targets_file="$(find build -name TargetDirectories.txt | head -n 1)"
          if [ -z "$targets_file" ]; then
            echo "TargetDirectories.txt not found under build/; skipping AU."
          elif grep -q "${{ env.PLUGIN_NAME }}_AU.dir" "$targets_file"; then
            cmake --build build --config Release --target "${{ env.PLUGIN_NAME }}_AU"
          else
            echo "AU target ${{ env.PLUGIN_NAME }}_AU is not available; skipping."
          fi

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ env.PLUGIN_NAME }}
          path: |
            build/**/*.vst3
            build/**/*.clap
            build/**/*.component
          retention-days: 30

  # ============================================
  # LINUX BUILD
  # ============================================
  build-linux:
    if: github.event.inputs.platforms == 'all' || contains(github.event.inputs.platforms, 'linux') || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libasound2-dev \
            libfreetype6-dev \
            libgl1-mesa-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libwebkit2gtk-4.1-dev \
            libjack-jackd2-dev \
            libcurl4-openssl-dev \
            xvfb

      - name: Configure CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
            -DAPC_AUTO_COPY_VST3_TO_SYSTEM_DIR=OFF \
            -DAPC_OPEN_BUILD_FOLDER_AFTER_BUILD=OFF \
            -DAPC_ENABLE_VISAGE=ON

      - name: Build VST3
        run: |
          cmake --build build --target "${{ env.PLUGIN_NAME }}_VST3"

      - name: Build CLAP
        run: |
          targets_file="$(find build -name TargetDirectories.txt | head -n 1)"
          if [ -z "$targets_file" ]; then
            echo "TargetDirectories.txt not found under build/; skipping CLAP."
          elif grep -q "${{ env.PLUGIN_NAME }}_CLAP.dir" "$targets_file"; then
            cmake --build build --target "${{ env.PLUGIN_NAME }}_CLAP"
          else
            echo "CLAP target ${{ env.PLUGIN_NAME }}_CLAP is not available; skipping."
          fi

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ env.PLUGIN_NAME }}
          path: |
            build/**/*.vst3
            build/**/*.clap
          retention-days: 30

  # ============================================
  # CREATE RELEASE
  # ============================================
  release:
    needs: [build-windows, build-macos, build-linux]
    if: always() && (needs.build-windows.result == 'success' || needs.build-macos.result == 'success' || needs.build-linux.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-${{ env.PLUGIN_NAME }}"

      - name: List Downloaded Artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f

      - name: Create Release Archives
        run: |
          PLUGIN_NAME="${{ env.PLUGIN_NAME }}"
          VERSION="${{ github.ref_name }}"
          
          mkdir -p release
          
          # Package Windows artifacts
          if [ -d "artifacts/windows-${PLUGIN_NAME}" ]; then
            cd "artifacts/windows-${PLUGIN_NAME}"
            zip -r "../../release/${PLUGIN_NAME}-${VERSION}-Windows.zip" .
            cd ../..
          fi
          
          # Package macOS artifacts
          if [ -d "artifacts/macos-${PLUGIN_NAME}" ]; then
            cd "artifacts/macos-${PLUGIN_NAME}"
            zip -r "../../release/${PLUGIN_NAME}-${VERSION}-macOS.zip" .
            cd ../..
          fi
          
          # Package Linux artifacts
          if [ -d "artifacts/linux-${PLUGIN_NAME}" ]; then
            cd "artifacts/linux-${PLUGIN_NAME}"
            zip -r "../../release/${PLUGIN_NAME}-${VERSION}-Linux.zip" .
            cd ../..
          fi
          
          echo "Release archives created:"
          ls -la release/

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## ${{ env.PLUGIN_NAME }} Release
            
            ### Installation
            - **Windows**: Extract the ZIP and copy VST3/CLAP to your plugins folder
            - **macOS**: Extract the ZIP and install VST3/CLAP components (plus AU for BASSic)
            - **Linux**: Extract the ZIP and copy VST3/CLAP to your plugins folder
            
            ### Supported Formats
            - VST3 (All platforms)
            - CLAP (All platforms)
            - AU (macOS, BASSic only)
            
            ### System Requirements
            - **Windows**: Windows 10/11, 64-bit, WebView2 Runtime
            - **macOS**: macOS 10.15+, Intel or Apple Silicon
            - **Linux**: Ubuntu 20.04+ or equivalent, WebKitGTK

      - name: Upload Release Artifacts (Manual Trigger)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ env.PLUGIN_NAME }}
          path: release/*
          retention-days: 30
